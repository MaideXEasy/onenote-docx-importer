<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Docx Importer</title>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600&display=swap');

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0f0f12;
      --surface: #1a1a20;
      --border: #2a2a35;
      --accent: #7c6af7;
      --accent-dim: #3d3568;
      --text: #e8e6f0;
      --text-dim: #7a7890;
      --success: #4ade80;
      --error: #f87171;
      --warning: #fbbf24;
    }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 20px 16px;
      font-size: 13px;
    }

    h1 {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.02em;
      margin-bottom: 4px;
      color: var(--text);
    }

    .subtitle {
      color: var(--text-dim);
      font-size: 11px;
      margin-bottom: 24px;
      font-family: 'DM Mono', monospace;
    }

    .section-label {
      font-size: 10px;
      font-weight: 500;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--text-dim);
      margin-bottom: 8px;
    }

    .drop-zone {
      border: 1.5px dashed var(--border);
      border-radius: 10px;
      padding: 28px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      background: var(--surface);
      margin-bottom: 16px;
      position: relative;
    }

    .drop-zone:hover, .drop-zone.drag-over {
      border-color: var(--accent);
      background: #1e1c2e;
    }

    .drop-zone input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
      width: 100%;
      height: 100%;
    }

    .drop-icon {
      font-size: 28px;
      margin-bottom: 8px;
      display: block;
    }

    .drop-text {
      color: var(--text-dim);
      font-size: 12px;
      line-height: 1.5;
    }

    .drop-text strong {
      color: var(--accent);
      font-weight: 500;
    }

    .file-list {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 16px;
      display: none;
    }

    .file-list.visible { display: block; }

    .file-list-header {
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .file-count {
      font-family: 'DM Mono', monospace;
      font-size: 11px;
      color: var(--accent);
    }

    .clear-btn {
      background: none;
      border: none;
      color: var(--text-dim);
      cursor: pointer;
      font-size: 11px;
      font-family: 'DM Sans', sans-serif;
      padding: 2px 6px;
      border-radius: 4px;
      transition: color 0.15s;
    }
    .clear-btn:hover { color: var(--error); }

    .file-item {
      padding: 8px 14px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
    }
    .file-item:last-child { border-bottom: none; }

    .file-item .file-name {
      flex: 1;
      font-family: 'DM Mono', monospace;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .file-item .file-path {
      color: var(--text-dim);
      font-size: 10px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100px;
    }

    .file-status {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--border);
      flex-shrink: 0;
    }
    .file-status.pending { background: var(--border); }
    .file-status.importing { background: var(--warning); animation: pulse 1s infinite; }
    .file-status.done { background: var(--success); }
    .file-status.error { background: var(--error); }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    .options {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 16px;
    }

    .option-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .option-row:last-child { margin-bottom: 0; }

    .option-label {
      font-size: 12px;
      color: var(--text);
    }
    .option-desc {
      font-size: 10px;
      color: var(--text-dim);
      margin-top: 1px;
    }

    .toggle {
      width: 36px;
      height: 20px;
      background: var(--border);
      border-radius: 10px;
      position: relative;
      cursor: pointer;
      transition: background 0.2s;
      flex-shrink: 0;
    }
    .toggle.on { background: var(--accent); }
    .toggle::after {
      content: '';
      position: absolute;
      width: 14px;
      height: 14px;
      background: white;
      border-radius: 50%;
      top: 3px;
      left: 3px;
      transition: left 0.2s;
    }
    .toggle.on::after { left: 19px; }

    .import-btn {
      width: 100%;
      padding: 12px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 10px;
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      letter-spacing: 0.02em;
      margin-bottom: 12px;
    }

    .import-btn:hover:not(:disabled) { background: #6a59e0; transform: translateY(-1px); }
    .import-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

    .progress-bar {
      height: 3px;
      background: var(--border);
      border-radius: 2px;
      overflow: hidden;
      margin-bottom: 12px;
      display: none;
    }
    .progress-bar.visible { display: block; }
    .progress-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 2px;
      transition: width 0.3s ease;
      width: 0%;
    }

    .log {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 14px;
      font-family: 'DM Mono', monospace;
      font-size: 10px;
      color: var(--text-dim);
      max-height: 120px;
      overflow-y: auto;
      display: none;
      line-height: 1.7;
    }
    .log.visible { display: block; }
    .log .log-ok { color: var(--success); }
    .log .log-err { color: var(--error); }
    .log .log-info { color: var(--accent); }

    .info-box {
      background: #1c1a2e;
      border: 1px solid var(--accent-dim);
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 11px;
      color: var(--text-dim);
      line-height: 1.5;
      margin-top: 12px;
    }
    .info-box strong { color: var(--accent); }
  </style>
</head>
<body>

<h1>üìÑ Docx Importer</h1>
<div class="subtitle">‚Üí OneNote Seiten-Import</div>

<div class="section-label">Dateien ausw√§hlen</div>
<div class="drop-zone" id="dropZone">
  <input type="file" id="fileInput" multiple accept=".docx" />
  <span class="drop-icon">üìÅ</span>
  <div class="drop-text">
    <strong>Klicken</strong> oder Dateien hierher ziehen<br>
    Mehrere .docx Dateien gleichzeitig m√∂glich
  </div>
</div>

<div class="file-list" id="fileList">
  <div class="file-list-header">
    <span class="file-count" id="fileCount">0 Dateien</span>
    <button class="clear-btn" onclick="clearFiles()">‚úï leeren</button>
  </div>
  <div id="fileItems"></div>
</div>

<div class="section-label">Optionen</div>
<div class="options">
  <div class="option-row">
    <div>
      <div class="option-label">Dateiname als Seitentitel</div>
      <div class="option-desc">z.B. "Protokoll_2024.docx" ‚Üí "Protokoll 2024"</div>
    </div>
    <div class="toggle on" id="toggleTitle" onclick="this.classList.toggle('on')"></div>
  </div>
  <div class="option-row">
    <div>
      <div class="option-label">Inhalt als formatierten Text</div>
      <div class="option-desc">√úberschriften und Formatierung beibehalten</div>
    </div>
    <div class="toggle on" id="toggleFormat" onclick="this.classList.toggle('on')"></div>
  </div>
</div>

<button class="import-btn" id="importBtn" onclick="startImport()" disabled>
  Import starten
</button>

<div class="progress-bar" id="progressBar">
  <div class="progress-fill" id="progressFill"></div>
</div>

<div class="log" id="log"></div>

<div class="info-box">
  <strong>Hinweis:</strong> Die Dateien werden in den aktuell ge√∂ffneten Abschnitt importiert. Wechsle in OneNote vorher zum gew√ºnschten Abschnitt.
</div>

<script>
  let selectedFiles = [];
  let fileStatuses = {};

  // Office.js ist per script-tag geladen, onReady abwarten
  window._officeReady = new Promise(resolve => {
    Office.onReady(info => {
      resolve(info);
    });
  });

  window._officeReady.then(info => {
    log('info', 'Add-in geladen ‚úì Host: ' + JSON.stringify(info.host));
  });

  const dropZone = document.getElementById('dropZone');
  const fileInput = document.getElementById('fileInput');

  dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
  dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
  dropZone.addEventListener('drop', e => {
    e.preventDefault();
    dropZone.classList.remove('drag-over');
    addFiles(Array.from(e.dataTransfer.files).filter(f => f.name.endsWith('.docx')));
  });

  fileInput.addEventListener('change', () => {
    addFiles(Array.from(fileInput.files));
    fileInput.value = '';
  });

  function addFiles(files) {
    files.forEach(f => {
      if (!selectedFiles.find(x => x.name === f.name && x.size === f.size)) {
        selectedFiles.push(f);
        fileStatuses[f.name] = 'pending';
      }
    });
    renderFileList();
  }

  function clearFiles() {
    selectedFiles = [];
    fileStatuses = {};
    renderFileList();
  }

  function renderFileList() {
    const list = document.getElementById('fileList');
    const items = document.getElementById('fileItems');
    const count = document.getElementById('fileCount');
    const btn = document.getElementById('importBtn');

    if (selectedFiles.length === 0) {
      list.classList.remove('visible');
      btn.disabled = true;
      return;
    }

    list.classList.add('visible');
    btn.disabled = false;
    count.textContent = selectedFiles.length + ' Datei' + (selectedFiles.length !== 1 ? 'en' : '');

    items.innerHTML = selectedFiles.map((f, i) => `
      <div class="file-item" id="item-${i}">
        <div class="file-status ${fileStatuses[f.name] || 'pending'}" id="status-${i}"></div>
        <div class="file-name">${f.name.replace('.docx', '')}</div>
        <div class="file-path">${formatSize(f.size)}</div>
      </div>
    `).join('');
  }

  function formatSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
  }

  function setFileStatus(index, status) {
    const el = document.getElementById('status-' + index);
    if (el) { el.className = 'file-status ' + status; }
  }

  function log(type, msg) {
    const logEl = document.getElementById('log');
    logEl.classList.add('visible');
    const line = document.createElement('div');
    line.className = 'log-' + type;
    const prefix = type === 'ok' ? '‚úì' : type === 'err' ? '‚úó' : '‚Üí';
    line.textContent = prefix + ' ' + msg;
    logEl.appendChild(line);
    logEl.scrollTop = logEl.scrollHeight;
  }

  function setProgress(pct) {
    document.getElementById('progressBar').classList.add('visible');
    document.getElementById('progressFill').style.width = pct + '%';
  }

  async function startImport() {
    if (selectedFiles.length === 0) return;

    const btn = document.getElementById('importBtn');
    btn.disabled = true;
    btn.textContent = 'Importiere...';

    const useTitle = document.getElementById('toggleTitle').classList.contains('on');

    let done = 0;

    // Warten bis Office.js vollst√§ndig bereit ist
    const info = await window._officeReady;

    // Debug-Info
    log('info', 'Office geladen: true');
    log('info', 'Host: ' + JSON.stringify(info.host));
    log('info', 'OneNote: ' + (typeof OneNote));
    log('info', 'OneNote.run: ' + (typeof OneNote !== 'undefined' ? typeof OneNote.run : 'n/a'));

    if (typeof OneNote === 'undefined' || typeof OneNote.run === 'undefined') {
      log('err', 'OneNote API nicht verf√ºgbar. Bitte Add-in schlie√üen und neu √∂ffnen.');
      btn.disabled = false;
      btn.textContent = 'Import starten';
      return;
    }

    for (let i = 0; i < selectedFiles.length; i++) {
      const file = selectedFiles[i];
      if (!file || !file.name) continue;

      const baseName = file.name.replace(/\.docx$/i, '');
      const pageName = useTitle
        ? baseName.replace(/[_\-]/g, ' ')
        : baseName;

      setFileStatus(i, 'importing');
      log('info', pageName + ' ...');

      try {
        const htmlContent = await readDocxAsText(file);

        await OneNote.run(async context => {
          const section = context.application.getActiveSection();
          section.load('id');
          await context.sync();

          const newPage = section.addPage();
          newPage.title = pageName;

          if (htmlContent && htmlContent !== null && String(htmlContent).trim().length > 0) {
            newPage.addOutline(10, 80, String(htmlContent));
          }

          await context.sync();
        });

        setFileStatus(i, 'done');
        log('ok', pageName);
      } catch (err) {
        setFileStatus(i, 'error');
        log('err', pageName + ': ' + err.message);
      }

      done++;
      setProgress(Math.round((done / selectedFiles.length) * 100));
    }

    btn.textContent = '‚úì Import abgeschlossen';
    log('ok', 'Fertig! ' + done + ' Seiten importiert.');
  }

  async function readDocxAsText(file) {
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onload = async e => {
        try {
          const zip = await JSZip.loadAsync(e.target.result);
          const xmlFile = zip.file('word/document.xml');
          if (!xmlFile) { resolve(''); return; }

          const xmlText = await xmlFile.async('string');

          // XML parsen
          const parser = new DOMParser();
          const doc = parser.parseFromString(xmlText, 'application/xml');

          // Abs√§tze extrahieren
          const paragraphs = doc.querySelectorAll('p');
          let html = '';

          paragraphs.forEach(p => {
            // √úberschriften erkennen
            const styleEl = p.querySelector('pStyle');
            const style = styleEl ? styleEl.getAttribute('w:val') : '';

            // Text aus allen <w:t> Elementen sammeln
            const texts = p.querySelectorAll('t');
            let text = '';
            texts.forEach(t => { text += t.textContent; });

            if (!text.trim()) {
              html += '<p>&nbsp;</p>';
            } else if (style && style.startsWith('Heading') || style && style.startsWith('berschrift')) {
              const level = style.replace(/[^0-9]/g, '') || '1';
              html += `<h${level}>${escapeHtml(text)}</h${level}>`;
            } else {
              html += `<p>${escapeHtml(text)}</p>`;
            }
          });

          resolve(html || '');
        } catch(err) {
          resolve('');
        }
      };
      reader.onerror = () => resolve('');
      reader.readAsArrayBuffer(file);
    });
  }

  function escapeHtml(text) {
    return text
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;');
  }
</script>
</body>
</html>
